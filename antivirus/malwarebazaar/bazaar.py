import hashlib
import json
from fame.core.module import AntivirusModule, ModuleInitializationError

try:
    import requests
    HAVE_REQUESTS = True
except ImportError:
    HAVE_REQUESTS = False

class MalwareBazaar(AntivirusModule):
    name = "MalwareBazaar"
    description = "Submit the file to MalwareBazaar."

    config = [
        {
            'name': 'api_endpoint',
            'type': 'str',
            'default': 'https://mb-api.abuse.ch/api/v1/',
            'description': "URL of Malware Bazaar's API endpoint."
        },
        {
            'name': 'apikey',
            'type': 'str',
            'description': 'API Key to use to connect to your Malware Bazaar account.'
        },
        {
            'name': 'fame_api',
            'type': 'str',
            'default': 'http://localhost:4200/',
            'description': "URL of FAME's API endpoint."
        },
        {
            'name': 'fame_api_key',
            'type': 'str',
            'description': 'API Key to use to connect to your FAME account.'
        },
    ]

    def initialize(self):
        if not HAVE_REQUESTS:
            raise ModuleInitializationError(self, "Missing dependency: requests")
        return True


    def submit(self, file):

        data = {}

        # I can't think of a better way to get the meta data :(
        fp = open(file, 'rb')
        sha256 = hashlib.sha256(fp.read()).hexdigest()
        fp.close()
        fameheaders = {'Accept': "application/json",'X-API-KEY': self.fame_api_key}
        r = requests.get(self.fame_api+'files/sha256/'+sha256, verify=False, headers=fameheaders)
        result = r.json()
        data['tags'] = result['file']['probable_names']
        refs= []
        for item in result['file']['analysis']:
            if item['results'].get('hatching_triage'):
                url = item['results']['hatching_triage']['URL']
                if url not in refs:
                    refs.append(url)
        data['references'] = {'links':refs}

        #Submit to MalwareBazaar
        files = {'json_data': (None, json.dumps(data), 'application/json'),'file': (open(file,'rb'))}
        headers = {'API-KEY': self.apikey}
        response = requests.post(self.api_endpoint, files=files, verify=False, headers=headers)
        print("[MalwareBazaar] Submission status: " + response.text)


