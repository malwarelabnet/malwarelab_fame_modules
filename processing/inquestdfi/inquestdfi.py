import hashlib
import os
import time
from urllib.parse import urljoin

try:
    import requests
    HAVE_REQUESTS = True
except ImportError:
    HAVE_REQUESTS = False

from fame.common.utils import tempdir
from fame.common.exceptions import ModuleInitializationError, ModuleExecutionError
from fame.core.module import ProcessingModule


class InQuestDFI(ProcessingModule):
    name = "inquestdfi"
    description = "Submit the file to InQuest DFI"
    acts_on = ["word", "excel", "powerpoint"]

    config = [
        {
            'name': 'api_endpoint',
            'type': 'str',
            'default': 'https://labs.inquest.net/api/dfi/',
            'description': "URL of InQuest's API endpoint."
        },
        {
            'name': 'api_key',
            'type': 'str',
            'description': 'API Key to use to connect to your InQuest account.'
        },
        {
            'name': 'web_endpoint',
            'type': 'str',
            'default': 'https://labs.inquest.net/dfi/sha256/',
            'description': "URL of InQuest's web interface."
        },
        {
            'name': 'wait_timeout',
            'type': 'integer',
            'default': 5400,
            'description': 'Time in seconds that the module will wait for analysis to be over.'
        },
        {
            'name': 'wait_step',
            'type': 'integer',
            'default': 30,
            'description': "Time in seconds between two check of analysis status."
        },
        {
            'name': 'check_existing',
            'type': 'bool',
            'default': True,
            'description': 'Check for existing analysis retrieve most recent report will not re-submit file.',
            'option': True
        }
    ]

    permissions = {
        'inquestdfi_access': "For users that have access to Inquest DFI. Will display a link to analysis."
    }

    def initialize(self):
        # Check dependencies
        if not HAVE_REQUESTS:
            raise ModuleInitializationError(self, "Missing dependency: requests")

    def each_with_type(self, target, file_type):
        try:
            self.inquest = InQuestDFI(self.api_key)

            # Set root URLs
            self.results = dict()

            fp = open(target, 'rb')
            self.sha256sum = hashlib.sha256(fp.read()).hexdigest()
            fp.close()
            self.results['parent'] = self.sha256sum

            # First, submit the file
            if self.check_existing:
                self.search_file(target)
            else:
                self.submit_file(target)

            # Wait for analysis to be over
            self.wait_for_analysis()

            # Get report, and tag signatures
            self.process_report()

            # Add report URL to results
            self.results['URL'] = urljoin(self.web_endpoint, "{}".format(self.sha256sum))

        except Exception as error:
            self.log("debug", "{}".format(error))

        return True

    def search_file(self, filepath):
        API_KEY_STRING = 'Basic %s' % self.api_key
        auth_header={'Authorization': API_KEY_STRING}
        r = requests.get(self.api_endpoint + 'details?sha256=' + self.sha256sum, headers=auth_header)
        response = r.json()
        if response['success'] == True:
            self.log("debug", "Found existing report.")
        else:
            self.log("debug", "No reports found. Submitting file.")
            self.submit_file(filepath)

    def submit_file(self, filepath):
        basename = os.path.basename(filepath)
        fp = open(filepath, 'rb')
        API_KEY_STRING = 'Basic %s' % self.api_key
        auth_header={'Authorization': API_KEY_STRING}
        files = {'file':(basename, fp)}
        r = requests.post(self.api_endpoint + 'upload', files=files, headers=auth_header)
        response = r.json()
        fp.close()
        self.log("debug", response)

    def wait_for_analysis(self):
        waited_time = 0
        while waited_time < self.wait_timeout:
            API_KEY_STRING = 'Basic %s' % self.api_key
            auth_header={'Authorization': API_KEY_STRING}
            r = requests.get(self.api_endpoint + 'details?sha256=' + self.sha256sum, headers=auth_header)
            response = r.json()
            if response['success'] == True:
                break
            time.sleep(self.wait_step)
            waited_time += self.wait_step
        if response['success'] != True:
            raise ModuleExecutionError('could not get report before timeout.')

    def process_report(self):
        try:
            API_KEY_STRING = 'Basic %s' % self.api_key
            auth_header={'Authorization': API_KEY_STRING}
            r = requests.get(self.api_endpoint + 'details?sha256=' + self.sha256sum, headers=auth_header)
            response = r.json()
            self.extract_info(response)
        except Exception as error:
            raise ModuleExecutionError('Error encountered while processing report:\n{}'.format(error))

        try:
            API_KEY_STRING = 'Basic %s' % self.api_key
            auth_header={'Authorization': API_KEY_STRING}
            r = requests.get(self.api_endpoint + 'details/attributes?sha256=' + self.sha256sum, headers=auth_header)
            response = r.json()
            self.extract_iocs(response)
        except Exception as error:
            raise ModuleExecutionError('Error encountered while processing report:\n{}'.format(error))

    def extract_info(self, report):
        self.results['classification'] = ""
        self.results['malware_label'] = ""
        self.results['signatures'] = []
        if report.get('data'):
            self.results['classification'] = report['data']['classification']
            self.results['malware_label'] = report['data']['malware_label']
            for item in report['data']['inquest_alerts']:
                signature = dict() 
                if item.get('title'):
                    signature['name'] = item['title']
                if item.get('category'):
                    signature['severity'] = item['category']
                if item.get('description'):
                    signature['description'] = item['description']
                self.results['signatures'].append(signature)

    def extract_info(self, report):
        if report.get('data'):
            for item in report['data']:
                if item['attribute'] == "url":
                    self.add_ioc(item['value'], ["url"])
                if item['attribute'] == "domain":
                    self.add_ioc(item['value'], ["domain"])



